---
export const prerender = false;

import Header from "../../components/header/index.astro";
import "../../style/index.css";
import { getSanityPostBySlug } from "../../utils/getSanityPostBySlug";
import { portableTextToHtml } from "../../utils/portableTextToHtml";

const { slug } = Astro.params;

if (!slug) {
  return new Response(null, {
    status: 404,
    statusText: "Not Found",
  });
}

const post = await getSanityPostBySlug(slug);

if (!post) {
  return new Response(null, {
    status: 404,
    statusText: "Note not found",
  });
}

const {
  title,
  description: desc,
  tags,
  publishedAt,
  body,
  markdown,
  mainImage,
} = post;

import { renderMarkdown } from "../../utils/markdownRenderer";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content={desc || "Personal articles and thoughts"}
    />
    <meta name="author" content="Adetoye Anointing" />
    <meta property="og:title" content={title} />
    <meta
      property="og:description"
      content={desc || "Personal articles and thoughts"}
    />
    {
      mainImage?.asset?.url && (
        <meta property="og:image" content={mainImage.asset.url} />
      )
    }
    <meta property="og:type" content="article" />
    <meta
      property="article:published_time"
      content={publishedAt ? new Date(publishedAt).toISOString() : ""}
    />
    <!-- @ts-ignore -->
    {
      (tags as any[])?.map((tag: string) => (
        <meta property="article:tag" content={tag} />
      ))
    }
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta
      name="twitter:description"
      content={desc || "Personal articles and thoughts"}
    />
    <title>{title} | Articles</title>
  </head>
  <body>
    <Header title={title} />
    <main class="container mx-auto px-4 py-8 max-w-4xl">
      <div class="w-fit max-w-full flex items-start gap-2 mt-6 mx-auto">
        <main class="container">
          <div class="mb-8">
            <h1
              class="text-xl md:text-3xl font-bold leading-tight tracking-normal text-default"
            >
              {title}
            </h1>
            {desc && <p class="text-md mt-4 italic opacity-80">{desc}</p>}
            <p class="mt-4 text-xs italic opacity-60">
              Published on <b
                >{
                  publishedAt
                    ? new Date(publishedAt).toLocaleDateString("en-US", {
                        dateStyle: "long",
                      })
                    : "Unknown"
                }</b
              >
            </p>
          </div>

          {
            mainImage?.asset?.url && (
              <figure class="mb-12">
                <img
                  src={mainImage.asset.url}
                  alt={mainImage.alt || title}
                  class="w-full h-auto rounded-xl border border-white/10 shadow-2xl"
                />
                {mainImage.caption && (
                  <figcaption class="mt-4 text-center text-xs italic opacity-50">
                    {mainImage.caption}
                  </figcaption>
                )}
              </figure>
            )
          }

          <article class="portable-text">
            {
              body && body.length > 0 ? (
                <div set:html={portableTextToHtml(body)} />
              ) : markdown ? (
                <div set:html={renderMarkdown(markdown)} />
              ) : (
                <p class="italic opacity-50">No content available.</p>
              )
            }
          </article>

          {
            /* Navigation removed: previousNote/nextNote logic is not available with Sanity fetch. */
          }

          <div class="mt-12 pt-8">
            <a href="/articles" class="text-default hover:underline"
              >‚Üê Back to Articles</a
            >
          </div>
        </main>
      </div>
    </main>

    <style>
      .prose {
        color: inherit;
        font-family: inherit;
      }

      /* Base spacing for the article content */
      article {
        margin-top: 2rem;
      }
    </style>
  </body>
</html>
